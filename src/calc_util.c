#include "global.h"
#include "palette.h"
#include "random.h"
#include "sprite.h"
#include "trig.h"
#include "util.h"
#include "constants/rgb.h"

EWRAM_DATA static u8 sUnknown = 0;
EWRAM_DATA static u32 sRandCount = 0;

// IWRAM common
u32 gRngValue;
u32 gRng2Value;

// Values of sin(x*(π/128)) as Q8.8 fixed-point numbers from x = 0 to x = 319
const s16 gSineTable[] =
{
    Q_8_8(0),           // sin(0*(π/128))
    Q_8_8(0.0234375),   // sin(1*(π/128))
    Q_8_8(0.046875),    // sin(2*(π/128))
    Q_8_8(0.0703125),   // sin(3*(π/128))
    Q_8_8(0.09765625),  // sin(4*(π/128))
    Q_8_8(0.12109375),  // sin(5*(π/128))
    Q_8_8(0.14453125),  // sin(6*(π/128))
    Q_8_8(0.16796875),  // sin(7*(π/128))
    Q_8_8(0.19140625),  // sin(8*(π/128))
    Q_8_8(0.21875),     // sin(9*(π/128))
    Q_8_8(0.2421875),   // sin(10*(π/128))
    Q_8_8(0.265625),    // sin(11*(π/128))
    Q_8_8(0.2890625),   // sin(12*(π/128))
    Q_8_8(0.3125),      // sin(13*(π/128))
    Q_8_8(0.3359375),   // sin(14*(π/128))
    Q_8_8(0.359375),    // sin(15*(π/128))
    Q_8_8(0.37890625),  // sin(16*(π/128))
    Q_8_8(0.40234375),  // sin(17*(π/128))
    Q_8_8(0.42578125),  // sin(18*(π/128))
    Q_8_8(0.44921875),  // sin(19*(π/128))
    Q_8_8(0.46875),     // sin(20*(π/128))
    Q_8_8(0.4921875),   // sin(21*(π/128))
    Q_8_8(0.51171875),  // sin(22*(π/128))
    Q_8_8(0.53125),     // sin(23*(π/128))
    Q_8_8(0.5546875),   // sin(24*(π/128))
    Q_8_8(0.57421875),  // sin(25*(π/128))
    Q_8_8(0.59375),     // sin(26*(π/128))
    Q_8_8(0.61328125),  // sin(27*(π/128))
    Q_8_8(0.6328125),   // sin(28*(π/128))
    Q_8_8(0.65234375),  // sin(29*(π/128))
    Q_8_8(0.66796875),  // sin(30*(π/128))
    Q_8_8(0.6875),      // sin(31*(π/128))
    Q_8_8(0.70703125),  // sin(32*(π/128))
    Q_8_8(0.72265625),  // sin(33*(π/128))
    Q_8_8(0.73828125),  // sin(34*(π/128))
    Q_8_8(0.75390625),  // sin(35*(π/128))
    Q_8_8(0.76953125),  // sin(36*(π/128))
    Q_8_8(0.78515625),  // sin(37*(π/128))
    Q_8_8(0.80078125),  // sin(38*(π/128))
    Q_8_8(0.81640625),  // sin(39*(π/128))
    Q_8_8(0.828125),    // sin(40*(π/128))
    Q_8_8(0.84375),     // sin(41*(π/128))
    Q_8_8(0.85546875),  // sin(42*(π/128))
    Q_8_8(0.8671875),   // sin(43*(π/128))
    Q_8_8(0.87890625),  // sin(44*(π/128))
    Q_8_8(0.890625),    // sin(45*(π/128))
    Q_8_8(0.90234375),  // sin(46*(π/128))
    Q_8_8(0.9140625),   // sin(47*(π/128))
    Q_8_8(0.921875),    // sin(48*(π/128))
    Q_8_8(0.9296875),   // sin(49*(π/128))
    Q_8_8(0.94140625),  // sin(50*(π/128))
    Q_8_8(0.94921875),  // sin(51*(π/128))
    Q_8_8(0.953125),    // sin(52*(π/128))
    Q_8_8(0.9609375),   // sin(53*(π/128))
    Q_8_8(0.96875),     // sin(54*(π/128))
    Q_8_8(0.97265625),  // sin(55*(π/128))
    Q_8_8(0.98046875),  // sin(56*(π/128))
    Q_8_8(0.984375),    // sin(57*(π/128))
    Q_8_8(0.98828125),  // sin(58*(π/128))
    Q_8_8(0.9921875),   // sin(59*(π/128))
    Q_8_8(0.9921875),   // sin(60*(π/128))
    Q_8_8(0.99609375),  // sin(61*(π/128))
    Q_8_8(0.99609375),  // sin(62*(π/128))
    Q_8_8(0.99609375),  // sin(63*(π/128))
    Q_8_8(1),           // sin(64*(π/128))
    Q_8_8(0.99609375),  // sin(65*(π/128))
    Q_8_8(0.99609375),  // sin(66*(π/128))
    Q_8_8(0.99609375),  // sin(67*(π/128))
    Q_8_8(0.9921875),   // sin(68*(π/128))
    Q_8_8(0.9921875),   // sin(69*(π/128))
    Q_8_8(0.98828125),  // sin(70*(π/128))
    Q_8_8(0.984375),    // sin(71*(π/128))
    Q_8_8(0.98046875),  // sin(72*(π/128))
    Q_8_8(0.97265625),  // sin(73*(π/128))
    Q_8_8(0.96875),     // sin(74*(π/128))
    Q_8_8(0.9609375),   // sin(75*(π/128))
    Q_8_8(0.953125),    // sin(76*(π/128))
    Q_8_8(0.94921875),  // sin(77*(π/128))
    Q_8_8(0.94140625),  // sin(78*(π/128))
    Q_8_8(0.9296875),   // sin(79*(π/128))
    Q_8_8(0.921875),    // sin(80*(π/128))
    Q_8_8(0.9140625),   // sin(81*(π/128))
    Q_8_8(0.90234375),  // sin(82*(π/128))
    Q_8_8(0.890625),    // sin(83*(π/128))
    Q_8_8(0.87890625),  // sin(84*(π/128))
    Q_8_8(0.8671875),   // sin(85*(π/128))
    Q_8_8(0.85546875),  // sin(86*(π/128))
    Q_8_8(0.84375),     // sin(87*(π/128))
    Q_8_8(0.828125),    // sin(88*(π/128))
    Q_8_8(0.81640625),  // sin(89*(π/128))
    Q_8_8(0.80078125),  // sin(90*(π/128))
    Q_8_8(0.78515625),  // sin(91*(π/128))
    Q_8_8(0.76953125),  // sin(92*(π/128))
    Q_8_8(0.75390625),  // sin(93*(π/128))
    Q_8_8(0.73828125),  // sin(94*(π/128))
    Q_8_8(0.72265625),  // sin(95*(π/128))
    Q_8_8(0.70703125),  // sin(96*(π/128))
    Q_8_8(0.6875),      // sin(97*(π/128))
    Q_8_8(0.66796875),  // sin(98*(π/128))
    Q_8_8(0.65234375),  // sin(99*(π/128))
    Q_8_8(0.6328125),   // sin(100*(π/128))
    Q_8_8(0.61328125),  // sin(101*(π/128))
    Q_8_8(0.59375),     // sin(102*(π/128))
    Q_8_8(0.57421875),  // sin(103*(π/128))
    Q_8_8(0.5546875),   // sin(104*(π/128))
    Q_8_8(0.53125),     // sin(105*(π/128))
    Q_8_8(0.51171875),  // sin(106*(π/128))
    Q_8_8(0.4921875),   // sin(107*(π/128))
    Q_8_8(0.46875),     // sin(108*(π/128))
    Q_8_8(0.44921875),  // sin(109*(π/128))
    Q_8_8(0.42578125),  // sin(110*(π/128))
    Q_8_8(0.40234375),  // sin(111*(π/128))
    Q_8_8(0.37890625),  // sin(112*(π/128))
    Q_8_8(0.359375),    // sin(113*(π/128))
    Q_8_8(0.3359375),   // sin(114*(π/128))
    Q_8_8(0.3125),      // sin(115*(π/128))
    Q_8_8(0.2890625),   // sin(116*(π/128))
    Q_8_8(0.265625),    // sin(117*(π/128))
    Q_8_8(0.2421875),   // sin(118*(π/128))
    Q_8_8(0.21875),     // sin(119*(π/128))
    Q_8_8(0.19140625),  // sin(120*(π/128))
    Q_8_8(0.16796875),  // sin(121*(π/128))
    Q_8_8(0.14453125),  // sin(122*(π/128))
    Q_8_8(0.12109375),  // sin(123*(π/128))
    Q_8_8(0.09765625),  // sin(124*(π/128))
    Q_8_8(0.0703125),   // sin(125*(π/128))
    Q_8_8(0.046875),    // sin(126*(π/128))
    Q_8_8(0.0234375),   // sin(127*(π/128))
    Q_8_8(0),           // sin(128*(π/128))
    Q_8_8(-0.0234375),  // sin(129*(π/128))
    Q_8_8(-0.046875),   // sin(130*(π/128))
    Q_8_8(-0.0703125),  // sin(131*(π/128))
    Q_8_8(-0.09765625), // sin(132*(π/128))
    Q_8_8(-0.12109375), // sin(133*(π/128))
    Q_8_8(-0.14453125), // sin(134*(π/128))
    Q_8_8(-0.16796875), // sin(135*(π/128))
    Q_8_8(-0.19140625), // sin(136*(π/128))
    Q_8_8(-0.21875),    // sin(137*(π/128))
    Q_8_8(-0.2421875),  // sin(138*(π/128))
    Q_8_8(-0.265625),   // sin(139*(π/128))
    Q_8_8(-0.2890625),  // sin(140*(π/128))
    Q_8_8(-0.3125),     // sin(141*(π/128))
    Q_8_8(-0.3359375),  // sin(142*(π/128))
    Q_8_8(-0.359375),   // sin(143*(π/128))
    Q_8_8(-0.37890625), // sin(144*(π/128))
    Q_8_8(-0.40234375), // sin(145*(π/128))
    Q_8_8(-0.42578125), // sin(146*(π/128))
    Q_8_8(-0.44921875), // sin(147*(π/128))
    Q_8_8(-0.46875),    // sin(148*(π/128))
    Q_8_8(-0.4921875),  // sin(149*(π/128))
    Q_8_8(-0.51171875), // sin(150*(π/128))
    Q_8_8(-0.53125),    // sin(151*(π/128))
    Q_8_8(-0.5546875),  // sin(152*(π/128))
    Q_8_8(-0.57421875), // sin(153*(π/128))
    Q_8_8(-0.59375),    // sin(154*(π/128))
    Q_8_8(-0.61328125), // sin(155*(π/128))
    Q_8_8(-0.6328125),  // sin(156*(π/128))
    Q_8_8(-0.65234375), // sin(157*(π/128))
    Q_8_8(-0.66796875), // sin(158*(π/128))
    Q_8_8(-0.6875),     // sin(159*(π/128))
    Q_8_8(-0.70703125), // sin(160*(π/128))
    Q_8_8(-0.72265625), // sin(161*(π/128))
    Q_8_8(-0.73828125), // sin(162*(π/128))
    Q_8_8(-0.75390625), // sin(163*(π/128))
    Q_8_8(-0.76953125), // sin(164*(π/128))
    Q_8_8(-0.78515625), // sin(165*(π/128))
    Q_8_8(-0.80078125), // sin(166*(π/128))
    Q_8_8(-0.81640625), // sin(167*(π/128))
    Q_8_8(-0.828125),   // sin(168*(π/128))
    Q_8_8(-0.84375),    // sin(169*(π/128))
    Q_8_8(-0.85546875), // sin(170*(π/128))
    Q_8_8(-0.8671875),  // sin(171*(π/128))
    Q_8_8(-0.87890625), // sin(172*(π/128))
    Q_8_8(-0.890625),   // sin(173*(π/128))
    Q_8_8(-0.90234375), // sin(174*(π/128))
    Q_8_8(-0.9140625),  // sin(175*(π/128))
    Q_8_8(-0.921875),   // sin(176*(π/128))
    Q_8_8(-0.9296875),  // sin(177*(π/128))
    Q_8_8(-0.94140625), // sin(178*(π/128))
    Q_8_8(-0.94921875), // sin(179*(π/128))
    Q_8_8(-0.953125),   // sin(180*(π/128))
    Q_8_8(-0.9609375),  // sin(181*(π/128))
    Q_8_8(-0.96875),    // sin(182*(π/128))
    Q_8_8(-0.97265625), // sin(183*(π/128))
    Q_8_8(-0.98046875), // sin(184*(π/128))
    Q_8_8(-0.984375),   // sin(185*(π/128))
    Q_8_8(-0.98828125), // sin(186*(π/128))
    Q_8_8(-0.9921875),  // sin(187*(π/128))
    Q_8_8(-0.9921875),  // sin(188*(π/128))
    Q_8_8(-0.99609375), // sin(189*(π/128))
    Q_8_8(-0.99609375), // sin(190*(π/128))
    Q_8_8(-0.99609375), // sin(191*(π/128))
    Q_8_8(-1),          // sin(192*(π/128))
    Q_8_8(-0.99609375), // sin(193*(π/128))
    Q_8_8(-0.99609375), // sin(194*(π/128))
    Q_8_8(-0.99609375), // sin(195*(π/128))
    Q_8_8(-0.9921875),  // sin(196*(π/128))
    Q_8_8(-0.9921875),  // sin(197*(π/128))
    Q_8_8(-0.98828125), // sin(198*(π/128))
    Q_8_8(-0.984375),   // sin(199*(π/128))
    Q_8_8(-0.98046875), // sin(200*(π/128))
    Q_8_8(-0.97265625), // sin(201*(π/128))
    Q_8_8(-0.96875),    // sin(202*(π/128))
    Q_8_8(-0.9609375),  // sin(203*(π/128))
    Q_8_8(-0.953125),   // sin(204*(π/128))
    Q_8_8(-0.94921875), // sin(205*(π/128))
    Q_8_8(-0.94140625), // sin(206*(π/128))
    Q_8_8(-0.9296875),  // sin(207*(π/128))
    Q_8_8(-0.921875),   // sin(208*(π/128))
    Q_8_8(-0.9140625),  // sin(209*(π/128))
    Q_8_8(-0.90234375), // sin(210*(π/128))
    Q_8_8(-0.890625),   // sin(211*(π/128))
    Q_8_8(-0.87890625), // sin(212*(π/128))
    Q_8_8(-0.8671875),  // sin(213*(π/128))
    Q_8_8(-0.85546875), // sin(214*(π/128))
    Q_8_8(-0.84375),    // sin(215*(π/128))
    Q_8_8(-0.828125),   // sin(216*(π/128))
    Q_8_8(-0.81640625), // sin(217*(π/128))
    Q_8_8(-0.80078125), // sin(218*(π/128))
    Q_8_8(-0.78515625), // sin(219*(π/128))
    Q_8_8(-0.76953125), // sin(220*(π/128))
    Q_8_8(-0.75390625), // sin(221*(π/128))
    Q_8_8(-0.73828125), // sin(222*(π/128))
    Q_8_8(-0.72265625), // sin(223*(π/128))
    Q_8_8(-0.70703125), // sin(224*(π/128))
    Q_8_8(-0.6875),     // sin(225*(π/128))
    Q_8_8(-0.66796875), // sin(226*(π/128))
    Q_8_8(-0.65234375), // sin(227*(π/128))
    Q_8_8(-0.6328125),  // sin(228*(π/128))
    Q_8_8(-0.61328125), // sin(229*(π/128))
    Q_8_8(-0.59375),    // sin(230*(π/128))
    Q_8_8(-0.57421875), // sin(231*(π/128))
    Q_8_8(-0.5546875),  // sin(232*(π/128))
    Q_8_8(-0.53125),    // sin(233*(π/128))
    Q_8_8(-0.51171875), // sin(234*(π/128))
    Q_8_8(-0.4921875),  // sin(235*(π/128))
    Q_8_8(-0.46875),    // sin(236*(π/128))
    Q_8_8(-0.44921875), // sin(237*(π/128))
    Q_8_8(-0.42578125), // sin(238*(π/128))
    Q_8_8(-0.40234375), // sin(239*(π/128))
    Q_8_8(-0.37890625), // sin(240*(π/128))
    Q_8_8(-0.359375),   // sin(241*(π/128))
    Q_8_8(-0.3359375),  // sin(242*(π/128))
    Q_8_8(-0.3125),     // sin(243*(π/128))
    Q_8_8(-0.2890625),  // sin(244*(π/128))
    Q_8_8(-0.265625),   // sin(245*(π/128))
    Q_8_8(-0.2421875),  // sin(246*(π/128))
    Q_8_8(-0.21875),    // sin(247*(π/128))
    Q_8_8(-0.19140625), // sin(248*(π/128))
    Q_8_8(-0.16796875), // sin(249*(π/128))
    Q_8_8(-0.14453125), // sin(250*(π/128))
    Q_8_8(-0.12109375), // sin(251*(π/128))
    Q_8_8(-0.09765625), // sin(252*(π/128))
    Q_8_8(-0.0703125),  // sin(253*(π/128))
    Q_8_8(-0.046875),   // sin(254*(π/128))
    Q_8_8(-0.0234375),  // sin(255*(π/128))
    Q_8_8(0),           // sin(256*(π/128))
    Q_8_8(0.0234375),   // sin(257*(π/128))
    Q_8_8(0.046875),    // sin(258*(π/128))
    Q_8_8(0.0703125),   // sin(259*(π/128))
    Q_8_8(0.09765625),  // sin(260*(π/128))
    Q_8_8(0.12109375),  // sin(261*(π/128))
    Q_8_8(0.14453125),  // sin(262*(π/128))
    Q_8_8(0.16796875),  // sin(263*(π/128))
    Q_8_8(0.19140625),  // sin(264*(π/128))
    Q_8_8(0.21875),     // sin(265*(π/128))
    Q_8_8(0.2421875),   // sin(266*(π/128))
    Q_8_8(0.265625),    // sin(267*(π/128))
    Q_8_8(0.2890625),   // sin(268*(π/128))
    Q_8_8(0.3125),      // sin(269*(π/128))
    Q_8_8(0.3359375),   // sin(270*(π/128))
    Q_8_8(0.359375),    // sin(271*(π/128))
    Q_8_8(0.37890625),  // sin(272*(π/128))
    Q_8_8(0.40234375),  // sin(273*(π/128))
    Q_8_8(0.42578125),  // sin(274*(π/128))
    Q_8_8(0.44921875),  // sin(275*(π/128))
    Q_8_8(0.46875),     // sin(276*(π/128))
    Q_8_8(0.4921875),   // sin(277*(π/128))
    Q_8_8(0.51171875),  // sin(278*(π/128))
    Q_8_8(0.53125),     // sin(279*(π/128))
    Q_8_8(0.5546875),   // sin(280*(π/128))
    Q_8_8(0.57421875),  // sin(281*(π/128))
    Q_8_8(0.59375),     // sin(282*(π/128))
    Q_8_8(0.61328125),  // sin(283*(π/128))
    Q_8_8(0.6328125),   // sin(284*(π/128))
    Q_8_8(0.65234375),  // sin(285*(π/128))
    Q_8_8(0.66796875),  // sin(286*(π/128))
    Q_8_8(0.6875),      // sin(287*(π/128))
    Q_8_8(0.70703125),  // sin(288*(π/128))
    Q_8_8(0.72265625),  // sin(289*(π/128))
    Q_8_8(0.73828125),  // sin(290*(π/128))
    Q_8_8(0.75390625),  // sin(291*(π/128))
    Q_8_8(0.76953125),  // sin(292*(π/128))
    Q_8_8(0.78515625),  // sin(293*(π/128))
    Q_8_8(0.80078125),  // sin(294*(π/128))
    Q_8_8(0.81640625),  // sin(295*(π/128))
    Q_8_8(0.828125),    // sin(296*(π/128))
    Q_8_8(0.84375),     // sin(297*(π/128))
    Q_8_8(0.85546875),  // sin(298*(π/128))
    Q_8_8(0.8671875),   // sin(299*(π/128))
    Q_8_8(0.87890625),  // sin(300*(π/128))
    Q_8_8(0.890625),    // sin(301*(π/128))
    Q_8_8(0.90234375),  // sin(302*(π/128))
    Q_8_8(0.9140625),   // sin(303*(π/128))
    Q_8_8(0.921875),    // sin(304*(π/128))
    Q_8_8(0.9296875),   // sin(305*(π/128))
    Q_8_8(0.94140625),  // sin(306*(π/128))
    Q_8_8(0.94921875),  // sin(307*(π/128))
    Q_8_8(0.953125),    // sin(308*(π/128))
    Q_8_8(0.9609375),   // sin(309*(π/128))
    Q_8_8(0.96875),     // sin(310*(π/128))
    Q_8_8(0.97265625),  // sin(311*(π/128))
    Q_8_8(0.98046875),  // sin(312*(π/128))
    Q_8_8(0.984375),    // sin(313*(π/128))
    Q_8_8(0.98828125),  // sin(314*(π/128))
    Q_8_8(0.9921875),   // sin(315*(π/128))
    Q_8_8(0.9921875),   // sin(316*(π/128))
    Q_8_8(0.99609375),  // sin(317*(π/128))
    Q_8_8(0.99609375),  // sin(318*(π/128))
    Q_8_8(0.99609375),  // sin(319*(π/128))
};

// values of sin(x) as Q4.12 fixed-point numbers from x = 0° to x = 179°
const s16 gSineDegreeTable[] =
{
    Q_4_12(0),              // sin(0°)
    Q_4_12(0.017333984375), // sin(1°)
    Q_4_12(0.034912109375), // sin(2°)
    Q_4_12(0.05224609375),  // sin(3°)
    Q_4_12(0.06982421875),  // sin(4°)
    Q_4_12(0.087158203125), // sin(5°)
    Q_4_12(0.1044921875),   // sin(6°)
    Q_4_12(0.121826171875), // sin(7°)
    Q_4_12(0.13916015625),  // sin(8°)
    Q_4_12(0.156494140625), // sin(9°)
    Q_4_12(0.173583984375), // sin(10°)
    Q_4_12(0.19091796875),  // sin(11°)
    Q_4_12(0.2080078125),   // sin(12°)
    Q_4_12(0.224853515625), // sin(13°)
    Q_4_12(0.241943359375), // sin(14°)
    Q_4_12(0.2587890625),   // sin(15°)
    Q_4_12(0.275634765625), // sin(16°)
    Q_4_12(0.29248046875),  // sin(17°)
    Q_4_12(0.30908203125),  // sin(18°)
    Q_4_12(0.32568359375),  // sin(19°)
    Q_4_12(0.342041015625), // sin(20°)
    Q_4_12(0.3583984375),   // sin(21°)
    Q_4_12(0.37451171875),  // sin(22°)
    Q_4_12(0.390625),       // sin(23°)
    Q_4_12(0.40673828125),  // sin(24°)
    Q_4_12(0.422607421875), // sin(25°)
    Q_4_12(0.4384765625),   // sin(26°)
    Q_4_12(0.4541015625),   // sin(27°)
    Q_4_12(0.469482421875), // sin(28°)
    Q_4_12(0.48486328125),  // sin(29°)
    Q_4_12(0.5),            // sin(30°)
    Q_4_12(0.51513671875),  // sin(31°)
    Q_4_12(0.530029296875), // sin(32°)
    Q_4_12(0.544677734375), // sin(33°)
    Q_4_12(0.55908203125),  // sin(34°)
    Q_4_12(0.573486328125), // sin(35°)
    Q_4_12(0.587890625),    // sin(36°)
    Q_4_12(0.601806640625), // sin(37°)
    Q_4_12(0.61572265625),  // sin(38°)
    Q_4_12(0.62939453125),  // sin(39°)
    Q_4_12(0.642822265625), // sin(40°)
    Q_4_12(0.656005859375), // sin(41°)
    Q_4_12(0.669189453125), // sin(42°)
    Q_4_12(0.681884765625), // sin(43°)
    Q_4_12(0.694580078125), // sin(44°)
    Q_4_12(0.70703125),     // sin(45°)
    Q_4_12(0.71923828125),  // sin(46°)
    Q_4_12(0.7314453125),   // sin(47°)
    Q_4_12(0.7431640625),   // sin(48°)
    Q_4_12(0.754638671875), // sin(49°)
    Q_4_12(0.76611328125),  // sin(50°)
    Q_4_12(0.777099609375), // sin(51°)
    Q_4_12(0.7880859375),   // sin(52°)
    Q_4_12(0.798583984375), // sin(53°)
    Q_4_12(0.80908203125),  // sin(54°)
    Q_4_12(0.819091796875), // sin(55°)
    Q_4_12(0.8291015625),   // sin(56°)
    Q_4_12(0.838623046875), // sin(57°)
    Q_4_12(0.84814453125),  // sin(58°)
    Q_4_12(0.857177734375), // sin(59°)
    Q_4_12(0.865966796875), // sin(60°)
    Q_4_12(0.87451171875),  // sin(61°)
    Q_4_12(0.883056640625), // sin(62°)
    Q_4_12(0.89111328125),  // sin(63°)
    Q_4_12(0.898681640625), // sin(64°)
    Q_4_12(0.90625),        // sin(65°)
    Q_4_12(0.91357421875),  // sin(66°)
    Q_4_12(0.92041015625),  // sin(67°)
    Q_4_12(0.92724609375),  // sin(68°)
    Q_4_12(0.93359375),     // sin(69°)
    Q_4_12(0.939697265625), // sin(70°)
    Q_4_12(0.945556640625), // sin(71°)
    Q_4_12(0.951171875),    // sin(72°)
    Q_4_12(0.956298828125), // sin(73°)
    Q_4_12(0.961181640625), // sin(74°)
    Q_4_12(0.9658203125),   // sin(75°)
    Q_4_12(0.97021484375),  // sin(76°)
    Q_4_12(0.974365234375), // sin(77°)
    Q_4_12(0.97802734375),  // sin(78°)
    Q_4_12(0.981689453125), // sin(79°)
    Q_4_12(0.98486328125),  // sin(80°)
    Q_4_12(0.98779296875),  // sin(81°)
    Q_4_12(0.990234375),    // sin(82°)
    Q_4_12(0.992431640625), // sin(83°)
    Q_4_12(0.994384765625), // sin(84°)
    Q_4_12(0.99609375),     // sin(85°)
    Q_4_12(0.99755859375),  // sin(86°)
    Q_4_12(0.99853515625),  // sin(87°)
    Q_4_12(0.999267578125), // sin(88°)
    Q_4_12(0.999755859375), // sin(89°)
    Q_4_12(1),              // sin(90°)
    Q_4_12(0.999755859375), // sin(91°)
    Q_4_12(0.999267578125), // sin(92°)
    Q_4_12(0.99853515625),  // sin(93°)
    Q_4_12(0.99755859375),  // sin(94°)
    Q_4_12(0.99609375),     // sin(95°)
    Q_4_12(0.994384765625), // sin(96°)
    Q_4_12(0.992431640625), // sin(97°)
    Q_4_12(0.990234375),    // sin(98°)
    Q_4_12(0.98779296875),  // sin(99°)
    Q_4_12(0.98486328125),  // sin(100°)
    Q_4_12(0.981689453125), // sin(101°)
    Q_4_12(0.97802734375),  // sin(102°)
    Q_4_12(0.974365234375), // sin(103°)
    Q_4_12(0.97021484375),  // sin(104°)
    Q_4_12(0.9658203125),   // sin(105°)
    Q_4_12(0.961181640625), // sin(106°)
    Q_4_12(0.956298828125), // sin(107°)
    Q_4_12(0.951171875),    // sin(108°)
    Q_4_12(0.945556640625), // sin(109°)
    Q_4_12(0.939697265625), // sin(110°)
    Q_4_12(0.93359375),     // sin(111°)
    Q_4_12(0.92724609375),  // sin(112°)
    Q_4_12(0.92041015625),  // sin(113°)
    Q_4_12(0.91357421875),  // sin(114°)
    Q_4_12(0.90625),        // sin(115°)
    Q_4_12(0.898681640625), // sin(116°)
    Q_4_12(0.89111328125),  // sin(117°)
    Q_4_12(0.883056640625), // sin(118°)
    Q_4_12(0.87451171875),  // sin(119°)
    Q_4_12(0.865966796875), // sin(120°)
    Q_4_12(0.857177734375), // sin(121°)
    Q_4_12(0.84814453125),  // sin(122°)
    Q_4_12(0.838623046875), // sin(123°)
    Q_4_12(0.8291015625),   // sin(124°)
    Q_4_12(0.819091796875), // sin(125°)
    Q_4_12(0.80908203125),  // sin(126°)
    Q_4_12(0.798583984375), // sin(127°)
    Q_4_12(0.7880859375),   // sin(128°)
    Q_4_12(0.777099609375), // sin(129°)
    Q_4_12(0.76611328125),  // sin(130°)
    Q_4_12(0.754638671875), // sin(131°)
    Q_4_12(0.7431640625),   // sin(132°)
    Q_4_12(0.7314453125),   // sin(133°)
    Q_4_12(0.71923828125),  // sin(134°)
    Q_4_12(0.70703125),     // sin(135°)
    Q_4_12(0.694580078125), // sin(136°)
    Q_4_12(0.681884765625), // sin(137°)
    Q_4_12(0.669189453125), // sin(138°)
    Q_4_12(0.656005859375), // sin(139°)
    Q_4_12(0.642822265625), // sin(140°)
    Q_4_12(0.62939453125),  // sin(141°)
    Q_4_12(0.61572265625),  // sin(142°)
    Q_4_12(0.601806640625), // sin(143°)
    Q_4_12(0.587890625),    // sin(144°)
    Q_4_12(0.573486328125), // sin(145°)
    Q_4_12(0.55908203125),  // sin(146°)
    Q_4_12(0.544677734375), // sin(147°)
    Q_4_12(0.530029296875), // sin(148°)
    Q_4_12(0.51513671875),  // sin(149°)
    Q_4_12(0.5),            // sin(150°)
    Q_4_12(0.48486328125),  // sin(151°)
    Q_4_12(0.469482421875), // sin(152°)
    Q_4_12(0.4541015625),   // sin(153°)
    Q_4_12(0.4384765625),   // sin(154°)
    Q_4_12(0.422607421875), // sin(155°)
    Q_4_12(0.40673828125),  // sin(156°)
    Q_4_12(0.390625),       // sin(157°)
    Q_4_12(0.37451171875),  // sin(158°)
    Q_4_12(0.3583984375),   // sin(159°)
    Q_4_12(0.342041015625), // sin(160°)
    Q_4_12(0.32568359375),  // sin(161°)
    Q_4_12(0.30908203125),  // sin(162°)
    Q_4_12(0.29248046875),  // sin(163°)
    Q_4_12(0.275634765625), // sin(164°)
    Q_4_12(0.2587890625),   // sin(165°)
    Q_4_12(0.241943359375), // sin(166°)
    Q_4_12(0.224853515625), // sin(167°)
    Q_4_12(0.2080078125),   // sin(168°)
    Q_4_12(0.19091796875),  // sin(169°)
    Q_4_12(0.173583984375), // sin(170°)
    Q_4_12(0.156494140625), // sin(171°)
    Q_4_12(0.13916015625),  // sin(172°)
    Q_4_12(0.121826171875), // sin(173°)
    Q_4_12(0.1044921875),   // sin(174°)
    Q_4_12(0.087158203125), // sin(175°)
    Q_4_12(0.06982421875),  // sin(176°)
    Q_4_12(0.05224609375),  // sin(177°)
    Q_4_12(0.034912109375), // sin(178°)
    Q_4_12(0.017333984375), // sin(179°)
};

// amplitude * sin(index*(π/128))
s16 Sin(s16 index, s16 amplitude)
{
    return (amplitude * gSineTable[index]) >> 8;
}

// amplitude * cos(index*(π/128))
s16 Cos(s16 index, s16 amplitude)
{
    return (amplitude * gSineTable[index + 64]) >> 8;
}

// angle in degrees
s16 Sin2(u16 angle)
{
    // Maybe this should be an int?
    u32 angleMod = angle % 180;
    bool32 negate = ((angle / 180) & 1);
    s16 value = gSineDegreeTable[angleMod];

    if (negate)
        return -value;
    else
        return value;
}

// angle in degrees
s16 Cos2(u16 angle)
{
    return Sin2(angle + 90);
}


u16 Random(void)
{
    gRngValue = ISO_RANDOMIZE1(gRngValue);
    sRandCount++;
    return (u16)(gRngValue >> 16);
}

void SeedRng(u16 seed)
{
    gRngValue = seed;
    sUnknown = 0;
}

void SeedRng2(u16 seed)
{
    gRng2Value = seed;
}

u16 Random2(void)
{
    gRng2Value = ISO_RANDOMIZE1(gRng2Value);
    return (u16)(gRng2Value >> 16);
}

const u32 gBitTable[] =
{
    1 << 0,
    1 << 1,
    1 << 2,
    1 << 3,
    1 << 4,
    1 << 5,
    1 << 6,
    1 << 7,
    1 << 8,
    1 << 9,
    1 << 10,
    1 << 11,
    1 << 12,
    1 << 13,
    1 << 14,
    1 << 15,
    1 << 16,
    1 << 17,
    1 << 18,
    1 << 19,
    1 << 20,
    1 << 21,
    1 << 22,
    1 << 23,
    1 << 24,
    1 << 25,
    1 << 26,
    1 << 27,
    1 << 28,
    1 << 29,
    1 << 30,
    1 << 31,
};

static const struct SpriteTemplate sInvisibleSpriteTemplate =
{
    .tileTag = 0,
    .paletteTag = 0,
    .oam = &gDummyOamData,
    .anims = gDummySpriteAnimTable,
    .images = NULL,
    .affineAnims = gDummySpriteAffineAnimTable,
    .callback = SpriteCallbackDummy,
};

static const u8 sSpriteDimensions[3][4][2] =
{
    // square
    {
        {1, 1},
        {2, 2},
        {4, 4},
        {8, 8},
    },

    // horizontal rectangle
    {
        {2, 1},
        {4, 1},
        {4, 2},
        {8, 4},
    },

    // vertical rectangle
    {
        {1, 2},
        {1, 4},
        {2, 4},
        {4, 8},
    },
};

static const u16 sCrc16Table[] =
{
    0x0000, 0x1189, 0x2312, 0x329B, 0x4624, 0x57AD, 0x6536, 0x74BF,
    0x8C48, 0x9DC1, 0xAF5A, 0xBED3, 0xCA6C, 0xDBE5, 0xE97E, 0xF8F7,
    0x1081, 0x0108, 0x3393, 0x221A, 0x56A5, 0x472C, 0x75B7, 0x643E,
    0x9CC9, 0x8D40, 0xBFDB, 0xAE52, 0xDAED, 0xCB64, 0xF9FF, 0xE876,
    0x2102, 0x308B, 0x0210, 0x1399, 0x6726, 0x76AF, 0x4434, 0x55BD,
    0xAD4A, 0xBCC3, 0x8E58, 0x9FD1, 0xEB6E, 0xFAE7, 0xC87C, 0xD9F5,
    0x3183, 0x200A, 0x1291, 0x0318, 0x77A7, 0x662E, 0x54B5, 0x453C,
    0xBDCB, 0xAC42, 0x9ED9, 0x8F50, 0xFBEF, 0xEA66, 0xD8FD, 0xC974,
    0x4204, 0x538D, 0x6116, 0x709F, 0x0420, 0x15A9, 0x2732, 0x36BB,
    0xCE4C, 0xDFC5, 0xED5E, 0xFCD7, 0x8868, 0x99E1, 0xAB7A, 0xBAF3,
    0x5285, 0x430C, 0x7197, 0x601E, 0x14A1, 0x0528, 0x37B3, 0x263A,
    0xDECD, 0xCF44, 0xFDDF, 0xEC56, 0x98E9, 0x8960, 0xBBFB, 0xAA72,
    0x6306, 0x728F, 0x4014, 0x519D, 0x2522, 0x34AB, 0x0630, 0x17B9,
    0xEF4E, 0xFEC7, 0xCC5C, 0xDDD5, 0xA96A, 0xB8E3, 0x8A78, 0x9BF1,
    0x7387, 0x620E, 0x5095, 0x411C, 0x35A3, 0x242A, 0x16B1, 0x0738,
    0xFFCF, 0xEE46, 0xDCDD, 0xCD54, 0xB9EB, 0xA862, 0x9AF9, 0x8B70,
    0x8408, 0x9581, 0xA71A, 0xB693, 0xC22C, 0xD3A5, 0xE13E, 0xF0B7,
    0x0840, 0x19C9, 0x2B52, 0x3ADB, 0x4E64, 0x5FED, 0x6D76, 0x7CFF,
    0x9489, 0x8500, 0xB79B, 0xA612, 0xD2AD, 0xC324, 0xF1BF, 0xE036,
    0x18C1, 0x0948, 0x3BD3, 0x2A5A, 0x5EE5, 0x4F6C, 0x7DF7, 0x6C7E,
    0xA50A, 0xB483, 0x8618, 0x9791, 0xE32E, 0xF2A7, 0xC03C, 0xD1B5,
    0x2942, 0x38CB, 0x0A50, 0x1BD9, 0x6F66, 0x7EEF, 0x4C74, 0x5DFD,
    0xB58B, 0xA402, 0x9699, 0x8710, 0xF3AF, 0xE226, 0xD0BD, 0xC134,
    0x39C3, 0x284A, 0x1AD1, 0x0B58, 0x7FE7, 0x6E6E, 0x5CF5, 0x4D7C,
    0xC60C, 0xD785, 0xE51E, 0xF497, 0x8028, 0x91A1, 0xA33A, 0xB2B3,
    0x4A44, 0x5BCD, 0x6956, 0x78DF, 0x0C60, 0x1DE9, 0x2F72, 0x3EFB,
    0xD68D, 0xC704, 0xF59F, 0xE416, 0x90A9, 0x8120, 0xB3BB, 0xA232,
    0x5AC5, 0x4B4C, 0x79D7, 0x685E, 0x1CE1, 0x0D68, 0x3FF3, 0x2E7A,
    0xE70E, 0xF687, 0xC41C, 0xD595, 0xA12A, 0xB0A3, 0x8238, 0x93B1,
    0x6B46, 0x7ACF, 0x4854, 0x59DD, 0x2D62, 0x3CEB, 0x0E70, 0x1FF9,
    0xF78F, 0xE606, 0xD49D, 0xC514, 0xB1AB, 0xA022, 0x92B9, 0x8330,
    0x7BC7, 0x6A4E, 0x58D5, 0x495C, 0x3DE3, 0x2C6A, 0x1EF1, 0x0F78,
};

const u8 gMiscBlank_Gfx[] = INCBIN_U8("graphics/interface/blank.4bpp");

u8 CreateInvisibleSpriteWithCallback(void (*callback)(struct Sprite *))
{
    u8 sprite = CreateSprite(&sInvisibleSpriteTemplate, 248, 168, 14);
    gSprites[sprite].invisible = TRUE;
    gSprites[sprite].callback = callback;
    return sprite;
}

// Should be u16 pointers but tasks uses s16 so we have to use this
void StoreWordInTwoHalfwords(s16 *h, u32 w)
{
    h[0] = (s16)(w);
    h[1] = (s16)(w >> 16);
}

void LoadWordFromTwoHalfwords(s16 *h, u32 *w)
{
    *w = (h[0] & 0xffff) | (h[1] << 16);
}

void SetBgAffineStruct(struct BgAffineSrcData *src, s32 texX, s32 texY, s16 scrX, s16 scrY, s16 sx, s16 sy, u16 alpha)
{
    src->texX = texX;
    src->texY = texY;
    src->scrX = scrX;
    src->scrY = scrY;
    src->sx = sx;
    src->sy = sy;
    src->alpha = alpha;
}

void DoBgAffineSet(struct BgAffineDstData *dest, s32 texX, s32 texY, s16 scrX, s16 scrY, s16 sx, s16 sy, u16 alpha)
{
    struct BgAffineSrcData src;

    SetBgAffineStruct(&src, texX, texY, scrX, scrY, sx, sy, alpha);
    BgAffineSet(&src, dest, 1);
}

void CopySpriteTiles(u8 shape, u8 size, u8 *tiles, u16 *tilemap, u8 *output)
{
    u8 x, y;
    s8 i, j;
    u8 xflip[32];
    u8 h = sSpriteDimensions[shape][size][1];
    u8 w = sSpriteDimensions[shape][size][0];

    for (y = 0; y < h; y++)
    {
        for (x = 0; x < w; x++)
        {
            // Maybe better off as a u32?
            u16 tile = (*tilemap & 0x3ff) * 32;

            if ((*tilemap & 0xc00) == 0)
            {
                CpuCopy32(tiles + tile, output, 32);
            }
            //else if(((*tilemap) & 0x0800) && (((*tilemap) & 0x0400) == 0))
            else if ((*tilemap & 0xc00) == 0x800)  // yflip
            {
                for (i = 0; i < 8; i++)
                    CpuCopy32(tiles + (tile + (7 - i) * 4), output + i * 4, 4);
            }
            else  // xflip
            {
                for (i = 0; i < 8; i++)
                {
                    for (j = 0; j < 4; j++)
                    {
                        u8 i2 = i * 4;
                        xflip[i2 + (3-j)] = ((tiles[tile + i2 + j] & 0xf) << 4) | (tiles[tile + i2 + j] >> 4);
                    }
                }
                if (*tilemap & 0x800)  // yflip
                {
                    for (i = 0; i < 8; i++)
                        CpuCopy32(xflip + (7 - i) * 4, output + i * 4, 4);
                }
                else
                {
                    CpuCopy32(xflip, output, 32);
                }
            }
            tilemap++;
            output += 32;
        }
        tilemap += (32 - w);
    }
}

u8 CountTrailingZeroBits(u32 value)
{
    u8 i;

    for (i = 0; i < 32; i++)
    {
        if (value & 1)
            return i;
        value >>= 1;
    }
    return 0;
}

// Length should be u32 
u16 CalcCRC16(const u8 *data, s32 length)
{
    u16 i, j;
    u16 crc = 0x1121;

    for (i = 0; i < length; i++)
    {
        crc ^= data[i];
        for (j = 0; j < 8; j++)
        {
            if (crc & 1)
                crc = (crc >> 1) ^ 0x8408;
            else
                crc >>= 1;
        }
    }
    return ~crc;
}

u16 CalcCRC16WithTable(const u8 *data, u32 length)
{
    u16 i;
    u16 crc = 0x1121;
    u8 byte;

    for (i = 0; i < length; i++)
    {
        crc = (crc >> 8) ^ sCrc16Table[(u8)crc ^ data[i]];
    }
    return ~crc;
}

u32 CalcByteArraySum(const u8 *data, u32 length)
{
    u32 sum, i;

    sum = 0;
    for (i = 0; i < length; i++)
        sum += data[i];
    return sum;
}

void BlendPalette(u16 palOffset, u16 numEntries, u8 coeff, u16 blendColor)
{
    u16 i;
    for (i = 0; i < numEntries; i++)
    {
        u16 index = i + palOffset;
        struct PlttData *data1 = (struct PlttData *)&gPlttBufferUnfaded[index];
        s8 r = data1->r;
        s8 g = data1->g;
        s8 b = data1->b;
        struct PlttData *data2 = (struct PlttData *)&blendColor;
        gPlttBufferFaded[index] = RGB(r + (((data2->r - r) * coeff) >> 4),
                                      g + (((data2->g - g) * coeff) >> 4),
                                      b + (((data2->b - b) * coeff) >> 4));
    }
}
